TAP version 14
# Subtest: POST /api/sets - contract validation
{"level":30,"time":1759428137462,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-1","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 201 with valid set data
        not ok 1 - should return 201 Created
          ---
          compare: ===
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 39
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:39:7)
          source: |2
                });
          
                t.equal(response.statusCode, 201, 'should return 201 Created');
            ------^
          
                const body = JSON.parse(response.body);
          diff: |
            --- expected
            +++ actual
            @@ -1,1 +1,1 @@
            -201
            +401
          ...
        
        not ok 2 - response should contain id
          ---
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 42
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:42:7)
          source: >2
          
                const body = JSON.parse(response.body);
                t.ok(body.id, 'response should contain id');
            ------^
                t.equal(body.localId, validSetData.localId, 'response should echo localId');
                t.equal(body.synced, true, 'response should indicate synced=true');
          ...
        
        not ok 3 - response should echo localId
          ---
          compare: ===
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 43
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:43:7)
          source: >2
                const body = JSON.parse(response.body);
                t.ok(body.id, 'response should contain id');
                t.equal(body.localId, validSetData.localId, 'response should echo localId');
            ------^
                t.equal(body.synced, true, 'response should indicate synced=true');
              });
          diff: |
            --- expected
            +++ actual
            @@ -1,1 +1,1 @@
            -12345
            +undefined
          ...
        
        not ok 4 - response should indicate synced=true
          ---
          compare: ===
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 44
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:44:7)
          source: >2
                t.ok(body.id, 'response should contain id');
                t.equal(body.localId, validSetData.localId, 'response should echo localId');
                t.equal(body.synced, true, 'response should indicate synced=true');
            ------^
              });
          diff: |
            --- expected
            +++ actual
            @@ -1,1 +1,1 @@
            -true
            +undefined
          ...
        
        1..4
    not ok 1 - returns 201 with valid set data # time=293.739ms
      ---
      at:
        fileName: tests/contract/sets.test.ts
        lineNumber: 17
        columnNumber: 11
        typeName: Test
      source: |2
          const app = await buildApp();
      
          await t.test('returns 201 with valid set data', async (t) => {
        ----------^
            const validSetData = {
              workout_id: 1,
      ...
    
{"level":30,"time":1759428137478,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-1","res":{"statusCode":401},"responseTime":13.845950999995694,"msg":"request completed"}
{"level":30,"time":1759428137545,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-2","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for weight > 500kg
        ok 1 - should return 400 Bad Request for weight > 500
        1..1
    ok 2 - returns 400 for weight > 500kg # time=6.235ms
    
{"level":30,"time":1759428137548,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-2","res":{"statusCode":400},"err":{"type":"Error","message":"body/weight_kg must be <= 500","stack":"Error: body/weight_kg must be <= 500\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/weight_kg","schemaPath":"#/properties/weight_kg/maximum","keyword":"maximum","params":{"comparison":"<=","limit":500},"message":"must be <= 500"}],"validationContext":"body"},"msg":"body/weight_kg must be <= 500"}
{"level":30,"time":1759428137550,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-2","res":{"statusCode":400},"responseTime":4.591863000008743,"msg":"request completed"}
{"level":30,"time":1759428137553,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-3","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for reps > 50
        ok 1 - should return 400 Bad Request for reps > 50
        1..1
    ok 3 - returns 400 for reps > 50 # time=2.357ms
    
{"level":30,"time":1759428137553,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-3","res":{"statusCode":400},"err":{"type":"Error","message":"body/reps must be <= 50","stack":"Error: body/reps must be <= 50\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/reps","schemaPath":"#/properties/reps/maximum","keyword":"maximum","params":{"comparison":"<=","limit":50},"message":"must be <= 50"}],"validationContext":"body"},"msg":"body/reps must be <= 50"}
{"level":30,"time":1759428137554,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-3","res":{"statusCode":400},"responseTime":0.9592089999932796,"msg":"request completed"}
{"level":30,"time":1759428137556,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-4","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for rir > 4
        ok 1 - should return 400 Bad Request for rir > 4
        1..1
    ok 4 - returns 400 for rir > 4 # time=1.913ms
    
{"level":30,"time":1759428137556,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-4","res":{"statusCode":400},"err":{"type":"Error","message":"body/rir must be <= 4","stack":"Error: body/rir must be <= 4\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/rir","schemaPath":"#/properties/rir/maximum","keyword":"maximum","params":{"comparison":"<=","limit":4},"message":"must be <= 4"}],"validationContext":"body"},"msg":"body/rir must be <= 4"}
{"level":30,"time":1759428137557,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-4","res":{"statusCode":400},"responseTime":0.8585489999968559,"msg":"request completed"}
{"level":30,"time":1759428137559,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-5","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for weight < 0
        ok 1 - should return 400 Bad Request for negative weight
        1..1
    ok 5 - returns 400 for weight < 0 # time=1.841ms
    
{"level":30,"time":1759428137559,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-5","res":{"statusCode":400},"err":{"type":"Error","message":"body/weight_kg must be >= 0","stack":"Error: body/weight_kg must be >= 0\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/weight_kg","schemaPath":"#/properties/weight_kg/minimum","keyword":"minimum","params":{"comparison":">=","limit":0},"message":"must be >= 0"}],"validationContext":"body"},"msg":"body/weight_kg must be >= 0"}
{"level":30,"time":1759428137560,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-5","res":{"statusCode":400},"responseTime":0.7912550000473857,"msg":"request completed"}
{"level":30,"time":1759428137562,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-6","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for reps < 1
        ok 1 - should return 400 Bad Request for reps < 1
        1..1
    ok 6 - returns 400 for reps < 1 # time=1.804ms
    
{"level":30,"time":1759428137562,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-6","res":{"statusCode":400},"err":{"type":"Error","message":"body/reps must be >= 1","stack":"Error: body/reps must be >= 1\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/reps","schemaPath":"#/properties/reps/minimum","keyword":"minimum","params":{"comparison":">=","limit":1},"message":"must be >= 1"}],"validationContext":"body"},"msg":"body/reps must be >= 1"}
{"level":30,"time":1759428137562,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-6","res":{"statusCode":400},"responseTime":0.7308019999763928,"msg":"request completed"}
{"level":30,"time":1759428137565,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-7","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for rir < 0
        ok 1 - should return 400 Bad Request for rir < 0
        1..1
    ok 7 - returns 400 for rir < 0 # time=1.845ms
    
{"level":30,"time":1759428137565,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-7","res":{"statusCode":400},"err":{"type":"Error","message":"body/rir must be >= 0","stack":"Error: body/rir must be >= 0\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/rir","schemaPath":"#/properties/rir/minimum","keyword":"minimum","params":{"comparison":">=","limit":0},"message":"must be >= 0"}],"validationContext":"body"},"msg":"body/rir must be >= 0"}
{"level":30,"time":1759428137565,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-7","res":{"statusCode":400},"responseTime":0.7955129999900237,"msg":"request completed"}
{"level":30,"time":1759428137567,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-8","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for missing required fields
        ok 1 - should return 400 Bad Request for missing fields
        1..1
    ok 8 - returns 400 for missing required fields # time=1.835ms
    
{"level":30,"time":1759428137568,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-8","res":{"statusCode":400},"err":{"type":"Error","message":"body must have required property 'exercise_id'","stack":"Error: body must have required property 'exercise_id'\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"exercise_id"},"message":"must have required property 'exercise_id'"}],"validationContext":"body"},"msg":"body must have required property 'exercise_id'"}
{"level":30,"time":1759428137568,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-8","res":{"statusCode":400},"responseTime":0.8190380000160076,"msg":"request completed"}
{"level":30,"time":1759428137570,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-9","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 401 unauthorized without JWT
        ok 1 - should return 401 Unauthorized without Authorization header
        1..1
    ok 9 - returns 401 unauthorized without JWT # time=2.53ms
    
{"level":30,"time":1759428137571,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-9","res":{"statusCode":401},"responseTime":1.1512459999648854,"msg":"request completed"}
{"level":30,"time":1759428137574,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-a","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 401 with invalid JWT
        ok 1 - should return 401 Unauthorized with invalid token
        1..1
    ok 10 - returns 401 with invalid JWT # time=2.365ms
    
{"level":30,"time":1759428137575,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-a","res":{"statusCode":401},"responseTime":0.9811980000231415,"msg":"request completed"}
{"level":30,"time":1759428137578,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-b","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: validates request schema matches OpenAPI spec
        1..0
    ok 11 - validates request schema matches OpenAPI spec # time=1.936ms
    
{"level":30,"time":1759428137579,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-b","res":{"statusCode":401},"responseTime":0.89680300001055,"msg":"request completed"}
{"level":30,"time":1759428137581,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-c","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: validates response schema matches OpenAPI spec
        1..0
    ok 12 - validates response schema matches OpenAPI spec # time=1.687ms
    
    1..12
not ok 1 - POST /api/sets - contract validation # time=401.304ms
  ---
  at:
    fileName: tests/contract/sets.test.ts
    lineNumber: 13
    columnNumber: 1
    isToplevel: true
  source: |2
     */
  
    test('POST /api/sets - contract validation', async (t) => {
    ^
      // Setup test server with actual implementation
      const app = await buildApp();
  ...

{"level":30,"time":1759428137581,"pid":6715,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-c","res":{"statusCode":401},"responseTime":0.7812029999913648,"msg":"request completed"}
1..1
Database connection closed
