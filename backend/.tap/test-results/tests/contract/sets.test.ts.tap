TAP version 14
# Subtest: POST /api/sets - contract validation
{"level":30,"time":1759594755261,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-1","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 201 with valid set data
        not ok 1 - should return 201 Created
          ---
          compare: ===
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 39
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:39:7)
          source: |2
                });
          
                t.equal(response.statusCode, 201, 'should return 201 Created');
            ------^
          
                const body = JSON.parse(response.body);
          diff: |
            --- expected
            +++ actual
            @@ -1,1 +1,1 @@
            -201
            +401
          ...
        
        not ok 2 - response should contain id
          ---
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 42
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:42:7)
          source: >2
          
                const body = JSON.parse(response.body);
                t.ok(body.id, 'response should contain id');
            ------^
                t.equal(body.localId, validSetData.localId, 'response should echo localId');
                t.equal(body.synced, true, 'response should indicate synced=true');
          ...
        
        not ok 3 - response should echo localId
          ---
          compare: ===
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 43
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:43:7)
          source: >2
                const body = JSON.parse(response.body);
                t.ok(body.id, 'response should contain id');
                t.equal(body.localId, validSetData.localId, 'response should echo localId');
            ------^
                t.equal(body.synced, true, 'response should indicate synced=true');
              });
          diff: |
            --- expected
            +++ actual
            @@ -1,1 +1,1 @@
            -12345
            +undefined
          ...
        
        not ok 4 - response should indicate synced=true
          ---
          compare: ===
          at:
            fileName: tests/contract/sets.test.ts
            lineNumber: 44
            columnNumber: 7
            typeName: Test
          stack: |
            Test.<anonymous> (tests/contract/sets.test.ts:44:7)
          source: >2
                t.ok(body.id, 'response should contain id');
                t.equal(body.localId, validSetData.localId, 'response should echo localId');
                t.equal(body.synced, true, 'response should indicate synced=true');
            ------^
              });
          diff: |
            --- expected
            +++ actual
            @@ -1,1 +1,1 @@
            -true
            +undefined
          ...
        
        1..4
    not ok 1 - returns 201 with valid set data # time=520.505ms
      ---
      at:
        fileName: tests/contract/sets.test.ts
        lineNumber: 17
        columnNumber: 11
        typeName: Test
      source: |2
          const app = await buildApp();
      
          await t.test('returns 201 with valid set data', async (t) => {
        ----------^
            const validSetData = {
              workout_id: 1,
      ...
    
{"level":30,"time":1759594755284,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-1","res":{"statusCode":401},"responseTime":18.754579000175,"msg":"request completed"}
{"level":30,"time":1759594755380,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-2","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for weight > 500kg
        ok 1 - should return 400 Bad Request for weight > 500
        1..1
    ok 2 - returns 400 for weight > 500kg # time=9.369ms
    
{"level":30,"time":1759594755383,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-2","res":{"statusCode":400},"err":{"type":"Error","message":"body/weight_kg must be <= 500","stack":"Error: body/weight_kg must be <= 500\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/weight_kg","schemaPath":"#/properties/weight_kg/maximum","keyword":"maximum","params":{"comparison":"<=","limit":500},"message":"must be <= 500"}],"validationContext":"body"},"msg":"body/weight_kg must be <= 500"}
{"level":30,"time":1759594755386,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-2","res":{"statusCode":400},"responseTime":6.336989000439644,"msg":"request completed"}
{"level":30,"time":1759594755390,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-3","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for reps > 50
        ok 1 - should return 400 Bad Request for reps > 50
        1..1
    ok 3 - returns 400 for reps > 50 # time=5.101ms
    
{"level":30,"time":1759594755391,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-3","res":{"statusCode":400},"err":{"type":"Error","message":"body/reps must be <= 50","stack":"Error: body/reps must be <= 50\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/reps","schemaPath":"#/properties/reps/maximum","keyword":"maximum","params":{"comparison":"<=","limit":50},"message":"must be <= 50"}],"validationContext":"body"},"msg":"body/reps must be <= 50"}
{"level":30,"time":1759594755392,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-3","res":{"statusCode":400},"responseTime":1.8612730000168085,"msg":"request completed"}
{"level":30,"time":1759594755397,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-4","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for rir > 4
        ok 1 - should return 400 Bad Request for rir > 4
        1..1
    ok 4 - returns 400 for rir > 4 # time=3.358ms
    
{"level":30,"time":1759594755398,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-4","res":{"statusCode":400},"err":{"type":"Error","message":"body/rir must be <= 4","stack":"Error: body/rir must be <= 4\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/rir","schemaPath":"#/properties/rir/maximum","keyword":"maximum","params":{"comparison":"<=","limit":4},"message":"must be <= 4"}],"validationContext":"body"},"msg":"body/rir must be <= 4"}
{"level":30,"time":1759594755398,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-4","res":{"statusCode":400},"responseTime":1.657336000353098,"msg":"request completed"}
{"level":30,"time":1759594755402,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-5","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for weight < 0
        ok 1 - should return 400 Bad Request for negative weight
        1..1
    ok 5 - returns 400 for weight < 0 # time=3.109ms
    
{"level":30,"time":1759594755403,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-5","res":{"statusCode":400},"err":{"type":"Error","message":"body/weight_kg must be >= 0","stack":"Error: body/weight_kg must be >= 0\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/weight_kg","schemaPath":"#/properties/weight_kg/minimum","keyword":"minimum","params":{"comparison":">=","limit":0},"message":"must be >= 0"}],"validationContext":"body"},"msg":"body/weight_kg must be >= 0"}
{"level":30,"time":1759594755403,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-5","res":{"statusCode":400},"responseTime":1.0409859996289015,"msg":"request completed"}
{"level":30,"time":1759594755406,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-6","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for reps < 1
        ok 1 - should return 400 Bad Request for reps < 1
        1..1
    ok 6 - returns 400 for reps < 1 # time=3.118ms
    
{"level":30,"time":1759594755407,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-6","res":{"statusCode":400},"err":{"type":"Error","message":"body/reps must be >= 1","stack":"Error: body/reps must be >= 1\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/reps","schemaPath":"#/properties/reps/minimum","keyword":"minimum","params":{"comparison":">=","limit":1},"message":"must be >= 1"}],"validationContext":"body"},"msg":"body/reps must be >= 1"}
{"level":30,"time":1759594755407,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-6","res":{"statusCode":400},"responseTime":1.0901539996266365,"msg":"request completed"}
{"level":30,"time":1759594755412,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-7","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for rir < 0
        ok 1 - should return 400 Bad Request for rir < 0
        1..1
    ok 7 - returns 400 for rir < 0 # time=3.76ms
    
{"level":30,"time":1759594755413,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-7","res":{"statusCode":400},"err":{"type":"Error","message":"body/rir must be >= 0","stack":"Error: body/rir must be >= 0\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"/rir","schemaPath":"#/properties/rir/minimum","keyword":"minimum","params":{"comparison":">=","limit":0},"message":"must be >= 0"}],"validationContext":"body"},"msg":"body/rir must be >= 0"}
{"level":30,"time":1759594755413,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-7","res":{"statusCode":400},"responseTime":1.332643998786807,"msg":"request completed"}
{"level":30,"time":1759594755416,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-8","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 400 for missing required fields
        ok 1 - should return 400 Bad Request for missing fields
        1..1
    ok 8 - returns 400 for missing required fields # time=4.454ms
    
{"level":30,"time":1759594755418,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-8","res":{"statusCode":400},"err":{"type":"Error","message":"body must have required property 'exercise_id'","stack":"Error: body must have required property 'exercise_id'\n    at defaultSchemaErrorFormatter (/home/asigator/fitness2025/backend/node_modules/fastify/lib/context.js:114:10)\n    at wrapValidationError (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:249:17)\n    at validate (/home/asigator/fitness2025/backend/node_modules/fastify/lib/validation.js:167:16)\n    at preValidationCallback (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:93:25)\n    at handler (/home/asigator/fitness2025/backend/node_modules/fastify/lib/handleRequest.js:77:7)\n    at /home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:199:9\n    at AsyncResource.runInAsyncScope (node:async_hooks:206:9)\n    at done (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:192:14)\n    at Parser.defaultJsonParser [as fn] (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:304:5)\n    at Request.onEnd (/home/asigator/fitness2025/backend/node_modules/fastify/lib/contentTypeParser.js:283:27)","statusCode":400,"code":"FST_ERR_VALIDATION","validation":[{"instancePath":"","schemaPath":"#/required","keyword":"required","params":{"missingProperty":"exercise_id"},"message":"must have required property 'exercise_id'"}],"validationContext":"body"},"msg":"body must have required property 'exercise_id'"}
{"level":30,"time":1759594755418,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-8","res":{"statusCode":400},"responseTime":2.007659999653697,"msg":"request completed"}
{"level":30,"time":1759594755423,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-9","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 401 unauthorized without JWT
        ok 1 - should return 401 Unauthorized without Authorization header
        1..1
    ok 9 - returns 401 unauthorized without JWT # time=4.091ms
    
{"level":30,"time":1759594755424,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-9","res":{"statusCode":401},"responseTime":1.306453000754118,"msg":"request completed"}
{"level":30,"time":1759594755428,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-a","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: returns 401 with invalid JWT
        ok 1 - should return 401 Unauthorized with invalid token
        1..1
    ok 10 - returns 401 with invalid JWT # time=3.475ms
    
{"level":30,"time":1759594755430,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-a","res":{"statusCode":401},"responseTime":1.396339001134038,"msg":"request completed"}
{"level":30,"time":1759594755432,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-b","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: validates request schema matches OpenAPI spec
        1..0
    ok 11 - validates request schema matches OpenAPI spec # time=3.161ms
    
{"level":30,"time":1759594755434,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-b","res":{"statusCode":401},"responseTime":1.8232090007513762,"msg":"request completed"}
{"level":30,"time":1759594755437,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-c","req":{"method":"POST","url":"/api/sets","hostname":"localhost:80","remoteAddress":"127.0.0.1"},"msg":"incoming request"}
    # Subtest: validates response schema matches OpenAPI spec
        1..0
    ok 12 - validates response schema matches OpenAPI spec # time=2.497ms
    
    1..12
not ok 1 - POST /api/sets - contract validation # time=691.929ms
  ---
  at:
    fileName: tests/contract/sets.test.ts
    lineNumber: 13
    columnNumber: 1
    isToplevel: true
  source: |2
     */
  
    test('POST /api/sets - contract validation', async (t) => {
    ^
      // Setup test server with actual implementation
      const app = await buildApp();
  ...

{"level":30,"time":1759594755438,"pid":141273,"hostname":"asigator-Legion-5-17ACH6H","reqId":"req-c","res":{"statusCode":401},"responseTime":1.0812149997800589,"msg":"request completed"}
1..1
Database connection closed
