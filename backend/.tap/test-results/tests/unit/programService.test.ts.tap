TAP version 14
# Subtest: Program Service - advancePhase()
    # Subtest: MEV → MAV: Automatic progression with +20% volume
        ok 1 - Program starts in MEV phase
        ok 2 - Program has exercises
        ok 3 - Previous phase was MEV
        ok 4 - New phase is MAV
        ok 5 - Volume multiplier is 1.2
        ok 6 - All exercises updated
        ok 7 - Program phase updated to MAV
        ok 8 - Week counter reset to 1
        ok 9 - Exercise 29282: 3 sets → 4 sets (rounded)
        ok 10 - Exercise 29283: 4 sets → 5 sets (rounded)
        ok 11 - Exercise 29284: 3 sets → 4 sets (rounded)
        ok 12 - Exercise 29285: 3 sets → 4 sets (rounded)
        ok 13 - Exercise 29286: 4 sets → 5 sets (rounded)
        ok 14 - Exercise 29287: 3 sets → 4 sets (rounded)
        ok 15 - Exercise 29288: 3 sets → 4 sets (rounded)
        ok 16 - Exercise 29289: 4 sets → 5 sets (rounded)
        ok 17 - Exercise 29290: 4 sets → 5 sets (rounded)
        ok 18 - Exercise 29291: 3 sets → 4 sets (rounded)
        ok 19 - Exercise 29292: 3 sets → 4 sets (rounded)
        ok 20 - Exercise 29293: 3 sets → 4 sets (rounded)
        ok 21 - Exercise 29294: 3 sets → 4 sets (rounded)
        ok 22 - Exercise 29295: 4 sets → 5 sets (rounded)
        ok 23 - Exercise 29296: 3 sets → 4 sets (rounded)
        ok 24 - Exercise 29297: 4 sets → 5 sets (rounded)
        ok 25 - Exercise 29298: 3 sets → 4 sets (rounded)
        ok 26 - Exercise 29299: 3 sets → 4 sets (rounded)
        ok 27 - Exercise 29300: 3 sets → 4 sets (rounded)
        ok 28 - Exercise 29301: 4 sets → 5 sets (rounded)
        ok 29 - Exercise 29302: 3 sets → 4 sets (rounded)
        ok 30 - Exercise 29303: 4 sets → 5 sets (rounded)
        ok 31 - Exercise 29304: 3 sets → 4 sets (rounded)
        ok 32 - Exercise 29305: 3 sets → 4 sets (rounded)
        1..32
    ok 1 - MEV → MAV: Automatic progression with +20% volume # time=12.543ms
    
    # Subtest: MAV → MRV: Automatic progression with +15% volume
        ok 1 - Program is in MAV phase
        ok 2 - Previous phase was MAV
        ok 3 - New phase is MRV
        ok 4 - Volume multiplier is 1.15
        ok 5 - All exercises updated
        ok 6 - Exercise 29282: 4 sets → 5 sets (rounded)
        ok 7 - Exercise 29283: 5 sets → 6 sets (rounded)
        ok 8 - Exercise 29284: 4 sets → 5 sets (rounded)
        ok 9 - Exercise 29285: 4 sets → 5 sets (rounded)
        ok 10 - Exercise 29286: 5 sets → 6 sets (rounded)
        ok 11 - Exercise 29287: 4 sets → 5 sets (rounded)
        ok 12 - Exercise 29288: 4 sets → 5 sets (rounded)
        ok 13 - Exercise 29289: 5 sets → 6 sets (rounded)
        ok 14 - Exercise 29290: 5 sets → 6 sets (rounded)
        ok 15 - Exercise 29291: 4 sets → 5 sets (rounded)
        ok 16 - Exercise 29292: 4 sets → 5 sets (rounded)
        ok 17 - Exercise 29293: 4 sets → 5 sets (rounded)
        ok 18 - Exercise 29294: 4 sets → 5 sets (rounded)
        ok 19 - Exercise 29295: 5 sets → 6 sets (rounded)
        ok 20 - Exercise 29296: 4 sets → 5 sets (rounded)
        ok 21 - Exercise 29297: 5 sets → 6 sets (rounded)
        ok 22 - Exercise 29298: 4 sets → 5 sets (rounded)
        ok 23 - Exercise 29299: 4 sets → 5 sets (rounded)
        ok 24 - Exercise 29300: 4 sets → 5 sets (rounded)
        ok 25 - Exercise 29301: 5 sets → 6 sets (rounded)
        ok 26 - Exercise 29302: 4 sets → 5 sets (rounded)
        ok 27 - Exercise 29303: 5 sets → 6 sets (rounded)
        ok 28 - Exercise 29304: 4 sets → 5 sets (rounded)
        ok 29 - Exercise 29305: 4 sets → 5 sets (rounded)
        1..29
    ok 2 - MAV → MRV: Automatic progression with +15% volume # time=8.21ms
    
    # Subtest: MRV → Deload: Automatic progression with -50% volume
        ok 1 - Program is in MRV phase
        ok 2 - Previous phase was MRV
        ok 3 - New phase is Deload
        ok 4 - Volume multiplier is 0.5
        ok 5 - All exercises updated
        ok 6 - Exercise 29282: 5 sets → 3 sets (rounded)
        ok 7 - Exercise 29283: 6 sets → 3 sets (rounded)
        ok 8 - Exercise 29284: 5 sets → 3 sets (rounded)
        ok 9 - Exercise 29285: 5 sets → 3 sets (rounded)
        ok 10 - Exercise 29286: 6 sets → 3 sets (rounded)
        ok 11 - Exercise 29287: 5 sets → 3 sets (rounded)
        ok 12 - Exercise 29288: 5 sets → 3 sets (rounded)
        ok 13 - Exercise 29289: 6 sets → 3 sets (rounded)
        ok 14 - Exercise 29290: 6 sets → 3 sets (rounded)
        ok 15 - Exercise 29291: 5 sets → 3 sets (rounded)
        ok 16 - Exercise 29292: 5 sets → 3 sets (rounded)
        ok 17 - Exercise 29293: 5 sets → 3 sets (rounded)
        ok 18 - Exercise 29294: 5 sets → 3 sets (rounded)
        ok 19 - Exercise 29295: 6 sets → 3 sets (rounded)
        ok 20 - Exercise 29296: 5 sets → 3 sets (rounded)
        ok 21 - Exercise 29297: 6 sets → 3 sets (rounded)
        ok 22 - Exercise 29298: 5 sets → 3 sets (rounded)
        ok 23 - Exercise 29299: 5 sets → 3 sets (rounded)
        ok 24 - Exercise 29300: 5 sets → 3 sets (rounded)
        ok 25 - Exercise 29301: 6 sets → 3 sets (rounded)
        ok 26 - Exercise 29302: 5 sets → 3 sets (rounded)
        ok 27 - Exercise 29303: 6 sets → 3 sets (rounded)
        ok 28 - Exercise 29304: 5 sets → 3 sets (rounded)
        ok 29 - Exercise 29305: 5 sets → 3 sets (rounded)
        1..29
    ok 3 - MRV → Deload: Automatic progression with -50% volume # time=12.236ms
    
    # Subtest: Deload → MEV: Automatic progression with 2.0x volume (baseline reset)
        ok 1 - Program is in Deload phase
        not ok 2 - database is locked
          ---
          stack: >
            <anonymous> (src/services/programService.ts:388:20)
          
            sqliteTransaction
            (node_modules/better-sqlite3/lib/methods/transaction.js:65:24)
          
            advancePhase (src/services/programService.ts:407:10)
          
            Test.<anonymous> (tests/unit/programService.test.ts:181:20)
          at:
            fileName: src/services/programService.ts
            lineNumber: 388
            columnNumber: 20
            functionName: <anonymous>
          type: SqliteError
          code: SQLITE_BUSY_SNAPSHOT
          tapCaught: returnedPromiseRejection
          source: |2
                  for (const exercise of exercises) {
                    const newSets = Math.round(exercise.sets * volumeMultiplier);
                    updateStmt.run(newSets, exercise.id);
            -------------------^
                    exercisesUpdated++;
                  }
          ...
        
        1..2
    not ok 4 - Deload → MEV: Automatic progression with 2.0x volume (baseline reset) # time=28.182ms
      ---
      at:
        fileName: tests/unit/programService.test.ts
        lineNumber: 166
        columnNumber: 11
        typeName: Test
      source: >2
          });
      
          await t.test('Deload → MEV: Automatic progression with 2.0x volume (baseline reset)', async (t) => {
        ----------^
            // Ensure program is in Deload phase (reset from previous tests)
            db.prepare('UPDATE programs SET mesocycle_phase = ? WHERE id = ?').run('deload', programId);
      ...
    
    # Subtest: Manual phase transition: MEV → MRV (skip MAV)
        ok 1 - Previous phase was MEV
        ok 2 - New phase is MRV (skipped MAV)
        ok 3 - Volume multiplier is positive
        ok 4 - All exercises updated
        ok 5 - Program phase updated to MRV
        1..5
    ok 5 - Manual phase transition: MEV → MRV (skip MAV) # time=3.705ms
    
    # Subtest: Error: Invalid target_phase
        ok 1 - Throws error for invalid phase
        1..1
    ok 6 - Error: Invalid target_phase # time=2.413ms
    
    # Subtest: Error: Manual=true but target_phase missing
        ok 1 - Throws error when manual=true but target_phase is missing
        1..1
    ok 7 - Error: Manual=true but target_phase missing # time=0.446ms
    
    # Subtest: Error: Program not found
        ok 1 - Throws error for non-existent program
        1..1
    ok 8 - Error: Program not found # time=0.757ms
    
    # Subtest: Transaction atomicity: All exercises updated together
        ok 1 - All exercises updated in single transaction
        1..1
    ok 9 - Transaction atomicity: All exercises updated together # time=2.615ms
    
    # Subtest: Volume calculation example: MEV 10 sets → MAV 12 sets
        ok 1 - Started from MEV
        ok 2 - Advanced to MAV
        ok 3 - Multiplier is 1.2
        ok 4 - MEV 10 sets × 1.2 = MAV 12 sets
        1..4
    ok 10 - Volume calculation example: MEV 10 sets → MAV 12 sets # time=2.354ms
    
    1..10
not ok 1 - Program Service - advancePhase() # time=102.609ms
  ---
  at:
    fileName: tests/unit/programService.test.ts
    lineNumber: 25
    columnNumber: 5
    isToplevel: true
  source: |
    // No mock needed - use production database with cleanup
  
    tap.test('Program Service - advancePhase()', async (t) => {
    ----^
      let userId: number;
      let programId: number;
  ...

1..1
Database connection closed
